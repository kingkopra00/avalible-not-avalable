<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…ÙˆÙ‚Ù Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ - Ø§Ù„ØµÙŠØ¯Ù„Ø§Ù†ÙŠ Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø­Ø³Ù† Ø§Ù„Ù†Ø§Ø¬ÙŠ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-bg: #f0f2f5; --panel-bg: #ffffff; --accent: #2c3e50;
            --success: #27ae60; --warning: #d35400; --danger: #c0392b; --info: #2980b9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', Tahoma, sans-serif; }
        body { background: var(--main-bg); padding: 20px; direction: rtl; color: #333; }
        
        .container { 
            max-width: 900px; margin: 0 auto; background: var(--panel-bg); 
            border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); 
            overflow: hidden; min-height: 90vh; display: flex; flex-direction: column;
        }

        /* === Header Styling === */
        header.app-header { 
            background: linear-gradient(135deg, #2c3e50, #34495e); 
            color: white; padding: 30px; text-align: center; 
        }
        h1 { font-size: 2rem; margin-bottom: 5px; font-weight: 800; }

        /* === Report Preview Styling (Screen) === */
        .report-paper {
            background: white;
            padding: 40px;
            border: 1px solid #ddd;
            margin-bottom: 30px;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
        }

        /* Official Header */
        .official-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px double #333; padding-bottom: 15px; margin-bottom: 30px;
        }
        .oh-side { text-align: center; width: 200px; font-size: 0.9rem; font-weight: bold; line-height: 1.6; }
        .oh-center { font-size: 3rem; color: #2c3e50; }
        .report-title { text-align: center; margin: 20px 0; font-size: 1.5rem; text-decoration: underline; text-underline-offset: 8px; font-weight: 800; }

        /* Summary Cards */
        .status-summary { 
            display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; 
            flex-wrap: wrap;
        }
        .status-card { 
            background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; 
            padding: 15px 25px; text-align: center; min-width: 120px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .sc-count { font-size: 1.8rem; font-weight: bold; display: block; margin-top: 5px; }
        
        /* Tables Styling */
        .section-block { margin-bottom: 20px; }
        .section-header { 
            background: #34495e; color: white; padding: 8px 15px; 
            font-weight: bold; border: 1px solid #333; border-bottom: none; 
            font-size: 1.1rem;
        }
        
        .report-table { 
            width: 100%; border-collapse: collapse; 
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ø¶Ù…Ø§Ù† ØªÙ†Ø§Ø³Ù‚ Ø§Ù„ÙÙˆØ§ØµÙ„ ÙÙŠ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        .report-table th:nth-child(1), .report-table td:nth-child(1) { width: 8%; text-align: center; }
        .report-table th:nth-child(2), .report-table td:nth-child(2) { width: 62%; text-align: right; }
        .report-table th:nth-child(3), .report-table td:nth-child(3) { width: 30%; text-align: center; }

        .report-table th { 
            background: #f1f2f6; color: #333; padding: 10px; 
            border: 1px solid #333; font-weight: 800;
        }
        .report-table td { 
            padding: 8px; border: 1px solid #333; 
            vertical-align: middle; font-weight: 500;
        }
        
        /* Signatures Footer */
        .official-footer {
            display: flex; justify-content: space-between; margin-top: 60px; padding-top: 20px;
        }
        .sig-box { text-align: center; width: 30%; }
        .sig-line { border-top: 1px solid #333; margin-top: 40px; width: 80%; margin-left: auto; margin-right: auto; }

        /* === Input Screen Elements === */
        .upload-section, .input-screen { padding: 30px; flex: 1; }
        .input-screen { display: none; text-align: center; }
        
        select { padding: 15px; font-size: 1.1rem; border-radius: 10px; border: 2px solid #ddd; width: 100%; max-width: 450px; margin: 20px 0; background: white; }
        
        .start-btn { padding: 15px 50px; background: var(--success); color: white; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .start-btn:disabled { background: #bdc3c7; cursor: not-allowed; }

        /* Material Card */
        .material-card { background: #fff; padding: 40px 20px; border-radius: 16px; border: 2px solid #f1f2f6; margin: 20px 0; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .material-name { font-size: 1.8rem; font-weight: 800; color: var(--accent); margin-bottom: 10px; }
        
        .current-status-display { font-size: 1.1rem; margin: 15px auto; padding: 10px 20px; border-radius: 50px; font-weight: bold; width: fit-content; }
        .status-available-display { background: #d4edda; color: #155724; }
        .status-shortage-display { background: #fff3cd; color: #856404; }
        .status-missing-display { background: #f8d7da; color: #721c24; }
        .status-none-display { background: #f1f2f6; color: #95a5a6; }

        .status-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 30px auto; max-width: 650px; }
        .status-btn { padding: 20px 10px; border: none; border-radius: 12px; color: white; font-size: 1.1rem; font-weight: bold; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-available { background: var(--success); }
        .btn-shortage { background: var(--warning); }
        .btn-missing { background: var(--danger); }
        .btn-quantity { background: var(--info); }

        .nav-buttons { display: flex; justify-content: space-between; margin-top: 40px; }
        .nav-btn { padding: 10px 25px; background: white; border: 2px solid #eee; border-radius: 50px; cursor: pointer; font-weight: bold; }
        
        .search-container { position: relative; margin: 20px 0; }
        .search-input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 10px; }
        .suggestions-list { position: absolute; top: 105%; width: 100%; background: white; border: 1px solid #eee; border-radius: 10px; max-height: 250px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .suggestion-item { padding: 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; display: flex; justify-content: space-between; }
        .suggestion-item:hover { background: #f9f9f9; }

        .quantity-section { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); z-index: 200; text-align: center; border: 2px solid var(--accent); }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 199; display: none; }

        .finish-btn { margin-top: 30px; padding: 15px 40px; background: #8e44ad; color: white; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 1.1rem; }

        .action-buttons { padding: 20px; background: #34495e; display: flex; justify-content: center; gap: 15px; border-radius: 0 0 12px 12px; }
        .action-btn { padding: 12px 25px; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; }

        /* === PRINT MEDIA QUERY === */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background: white; padding: 0; -webkit-print-color-adjust: exact; }
            .container { box-shadow: none; max-width: 100%; margin: 0; border-radius: 0; }
            .app-header, .no-print, .action-buttons, .search-container, .nav-buttons, .status-buttons, .finish-btn, .upload-section, .input-screen { display: none !important; }
            .results-screen { display: block !important; padding: 0 !important; }
            .report-paper { border: none; shadow: none; padding: 0; margin: 0; }
            
            /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
            .report-table { border: 2px solid #000; }
            .report-table th { background-color: #e0e0e0 !important; border: 1px solid #000; color: black; }
            .report-table td { border: 1px solid #000; color: black; }
            .section-header { background-color: #333 !important; color: white !important; border: 1px solid #000; border-bottom: none; }
            
            .official-header { border-bottom: 2px solid black; }
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>

    <div class="container">
        <header class="app-header no-print">
            <h1>ğŸ“¦ Ù…ÙˆÙ‚Ù Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠ</h1>
        </header>
        
        <div id="upload-screen" class="upload-section">
            <div style="text-align: center; margin-top: 40px;">
                <label style="font-size: 1.2rem; font-weight: bold; color: var(--accent);">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…:</label><br>
                <select id="warehouse-select">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø®Ø²Ù† --</option>
                    <option value="antibiotics">ğŸ’Š Ø§Ù„Ù…Ø¶Ø§Ø¯Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©</option>
                    <option value="antiseptics">ğŸ§´ Ø§Ù„Ù…Ø·Ù‡Ø±Ø§Øª</option>
                    <option value="fluids">ğŸ’§ Ø§Ù„Ù…Ø­Ø§Ù„ÙŠÙ„ ÙˆØ§Ù„Ø³ÙˆØ§Ø¦Ù„</option>
                    <option value="suspentions">ğŸ§ª Ø§Ù„Ù…Ø³Ø§Ø­ÙŠÙ‚ (Suspensions)</option>
                    <option value="tables">ğŸ’Š Ø§Ù„Ø£Ù‚Ø±Ø§Øµ (Tablets)</option>
                    <option value="vials">ğŸ’‰ Ø§Ù„Ø§Ù…Ø¨ÙˆÙ„Ø§Øª ÙˆØ§Ù„ÙÙŠØ§Ù„Ø§Øª</option>
                </select>
                
                <div id="recovery-msg" style="display:none; color: #d35400; background: #fadbd8; padding: 10px; margin: 15px auto; border-radius: 8px; max-width: 450px;">
                    âš ï¸ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø®Ø²Ù†
                    <button id="clear-data-btn" style="background: #c0392b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Ø­Ø°Ù ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
                </div>

                <br>
                <button class="start-btn" id="start-btn" disabled>ğŸš€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
        </div>

        <div id="input-screen" class="input-screen">
            <div style="display:flex; justify-content:space-between; color: #7f8c8d; font-size: 0.9rem; margin-bottom: 10px;">
                <span>Ø§Ù„Ù‚Ø³Ù…: <strong id="current-warehouse-title" style="color: var(--accent);">...</strong></span>
                <span id="item-counter">0 / 0</span>
            </div>
            
            <div class="search-container no-print">
                <input type="text" id="smart-search" class="search-input" placeholder="ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ (Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©)...">
                <div id="search-suggestions" class="suggestions-list"></div>
            </div>

            <div class="material-card">
                <div class="material-name" id="current-material">...</div>
                <div class="current-status-display status-none-display" id="current-status-display">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¬Ø±Ø¯</div>
            </div>

            <div class="status-buttons no-print">
                <button class="status-btn btn-available" onclick="setStatus('available')">âœ… Ù…ØªÙˆÙØ± (1)</button>
                <button class="status-btn btn-shortage" onclick="setStatus('shortage')">âš ï¸ Ø´Ø­ÙŠØ­ (2)</button>
                <button class="status-btn btn-missing" onclick="setStatus('missing')">âŒ Ù…ÙÙ‚ÙˆØ¯ (3)</button>
                <button class="status-btn btn-quantity" id="quantity-btn">ğŸ”¢ Ø¹Ø¯Ø¯ (4)</button>
            </div>

            <div class="quantity-section" id="quantity-section">
                <h3 style="margin-bottom: 15px;">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©</h3>
                <input type="text" id="quantity-input" style="width: 100%; padding: 10px; font-size: 1.5rem; text-align: center; margin-bottom: 15px;" placeholder="0" inputmode="numeric">
                <button class="start-btn" id="quantity-submit" style="width: 100%; margin: 0;">Ø­ÙØ¸</button>
            </div>

            <div class="nav-buttons no-print">
                <button class="nav-btn" id="prev-btn">â¡ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                <button class="finish-btn" id="finish-btn" style="margin:0; padding: 10px 30px;">âœ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                <button class="nav-btn" id="next-btn">Ø§Ù„ØªØ§Ù„ÙŠ â¬…ï¸</button>
            </div>
        </div>

        <div id="results-screen" class="results-screen" style="display: none;">
            <div class="report-paper">
                <div class="official-header">
                    <div class="oh-side">
                        <p>Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚</p>
                        <p>ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø©</p>
                        <p>Ø¯Ø§Ø¦Ø±Ø© ØµØ­Ø© Ø§Ù„Ù…Ø«Ù†Ù‰ - Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„Ø©</p>
                    </div>
                    <div class="oh-center">â˜¤</div>
                    <div class="oh-side">
                        <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="header-date"></span></p>
                        <p>Ø§Ù„Ø¹Ø¯Ø¯: .............</p>
                    </div>
                </div>

                <h2 class="report-title">Ù…ÙˆÙ‚Ù Ù…Ø®Ø²Ù† <span id="report-wh-name"></span></h2>

                <div class="status-summary">
                    <div class="status-card">
                        <div style="color: var(--success); font-weight: bold;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªÙˆÙØ±Ø©</div>
                        <span class="sc-count" id="count-available">0</span>
                    </div>
                    <div class="status-card">
                        <div style="color: var(--warning); font-weight: bold;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø´Ø­ÙŠØ­Ø©</div>
                        <span class="sc-count" id="count-shortage">0</span>
                    </div>
                    <div class="status-card">
                        <div style="color: var(--danger); font-weight: bold;">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©</div>
                        <span class="sc-count" id="count-missing">0</span>
                    </div>
                </div>

                <div id="report-content"></div>

                <div class="official-footer">
                    <div class="sig-box">
                        <p>Ù…Ù†Ø¸Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>
                        <div class="sig-line"></div>
                    </div>
                    <div class="sig-box">
                        <p>Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²Ù†</p>
                        <div class="sig-line"></div>
                    </div>
                    <div class="sig-box">
                        <p>Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</p>
                        <div class="sig-line"></div>
                    </div>
                </div>
            </div>

            <div class="action-buttons no-print">
                <button class="action-btn" style="background: #2c3e50;" id="print-all-btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø±Ø³Ù…ÙŠØ© / PDF</button>
                <button class="action-btn" style="background: #27ae60;" id="export-excel-btn">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
                <button class="action-btn" style="background: #c0392b;" onclick="location.reload()">ğŸ  Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </div>

    <script>
        const githubBaseUrl = 'https://raw.githubusercontent.com/kingkopra00/avalible-not-avalable/main/';
        const fileMap = {
            'antibiotics': 'antibiotics.xlsx', 'antiseptics': 'antiseptics.xlsx',
            'fluids': 'fluids.xlsx', 'suspentions': 'suspentions.xlsx',
            'tables': 'tables.xlsx', 'vials': 'vials.xlsx'
        };
        const warehouseNames = {
            'antibiotics': 'Ø§Ù„Ù…Ø¶Ø§Ø¯Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©', 'antiseptics': 'Ø§Ù„Ù…Ø·Ù‡Ø±Ø§Øª',
            'fluids': 'Ø§Ù„Ù…Ø­Ø§Ù„ÙŠÙ„ ÙˆØ§Ù„Ø³ÙˆØ§Ø¦Ù„', 'suspentions': 'Ø§Ù„Ù…Ø³Ø§Ø­ÙŠÙ‚',
            'tables': 'Ø§Ù„Ø£Ù‚Ø±Ø§Øµ', 'vials': 'Ø§Ù„Ø§Ù…Ø¨ÙˆÙ„Ø§Øª ÙˆØ§Ù„ÙÙŠØ§Ù„Ø§Øª'
        };

        let materials = [];
        let inventoryData = {};
        let currentIndex = 0;
        let currentWarehouse = '';

        const els = {
            uploadScreen: document.getElementById('upload-screen'),
            inputScreen: document.getElementById('input-screen'),
            resultsScreen: document.getElementById('results-screen'),
            warehouseSelect: document.getElementById('warehouse-select'),
            startBtn: document.getElementById('start-btn'),
            clearDataBtn: document.getElementById('clear-data-btn'),
            currentMaterial: document.getElementById('current-material'),
            statusDisplay: document.getElementById('current-status-display'),
            itemCounter: document.getElementById('item-counter'),
            searchInput: document.getElementById('smart-search'),
            suggestionsBox: document.getElementById('search-suggestions'),
            qtySection: document.getElementById('quantity-section'),
            qtyInput: document.getElementById('quantity-input'),
            recoveryMsg: document.getElementById('recovery-msg'),
            overlay: document.getElementById('overlay')
        };

        function getFormattedDate() {
            const d = new Date();
            const toArabic = n => n.toString().replace(/\d/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©"[d]);
            return `${toArabic(d.getDate())}/${toArabic(d.getMonth()+1)}/${toArabic(d.getFullYear())}`;
        }

        // --- Ø§Ù„ØªØ­Ø¯ÙŠØ«: ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø£Ø¯Ù†Ø§Ù‡ Ù„ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ---
        function getFileName(ext) {
            const d = new Date();
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®: ÙŠÙˆÙ…-Ø´Ù‡Ø±-Ø³Ù†Ø© (Ù…Ø«Ø§Ù„: 18-11-2025)
            const dStr = `${d.getDate()}-${d.getMonth()+1}-${d.getFullYear()}`;
            
            // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù†
            let whName = warehouseNames[currentWarehouse] || 'Ø¹Ø§Ù…';
            
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨Ø®Ø·ÙˆØ· Ù„Ø¶Ù…Ø§Ù† Ø§Ø³Ù… Ù…Ù„Ù Ù†Ø¸ÙŠÙ
            // Ù…Ø«Ø§Ù„: "Ø§Ù„Ù…Ø¶Ø§Ø¯Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©" ØªØµØ¨Ø­ "Ø§Ù„Ù…Ø¶Ø§Ø¯Ø§Øª-Ø§Ù„Ø­ÙŠÙˆÙŠØ©"
            whName = whName.replace(/\s+/g, '-');

            // ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø§Ø³Ù…: Ù…ÙˆÙ‚Ù-Ù…Ø®Ø²Ù†-Ø§Ù„Ø§Ø³Ù…-Ø§Ù„ØªØ§Ø±ÙŠØ®
            const name = `Ù…ÙˆÙ‚Ù-Ù…Ø®Ø²Ù†-${whName}-${dStr}`;
            
            return ext ? `${name}.${ext}` : name;
        }

        els.warehouseSelect.addEventListener('change', () => {
            currentWarehouse = els.warehouseSelect.value;
            els.startBtn.disabled = !currentWarehouse;
            if (currentWarehouse) {
                const saved = localStorage.getItem('inv_' + currentWarehouse);
                els.recoveryMsg.style.display = saved ? 'block' : 'none';
                els.startBtn.textContent = saved ? "ğŸ“‚ Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¬Ø±Ø¯" : "ğŸš€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            }
        });

        els.clearDataBtn.addEventListener('click', () => {
            if (confirm('Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ØŸ')) {
                localStorage.removeItem('inv_' + currentWarehouse);
                els.recoveryMsg.style.display = 'none';
                els.startBtn.textContent = "ğŸš€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            }
        });

        els.startBtn.addEventListener('click', async () => {
            els.startBtn.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
            els.startBtn.disabled = true;
            try {
                const savedData = localStorage.getItem('inv_' + currentWarehouse);
                const response = await fetch(githubBaseUrl + fileMap[currentWarehouse]);
                if (!response.ok) throw new Error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
                const buffer = await response.arrayBuffer();
                const wb = XLSX.read(buffer, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                materials = json.slice(1).map(r => r[0] ? r[0].toString().trim() : null).filter(Boolean);
                
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    inventoryData = parsed.data || {};
                    currentIndex = parsed.index || 0;
                    if (currentIndex >= materials.length) currentIndex = 0;
                } else {
                    inventoryData = {};
                    currentIndex = 0;
                }

                els.uploadScreen.style.display = 'none';
                els.inputScreen.style.display = 'block';
                document.getElementById('current-warehouse-title').textContent = warehouseNames[currentWarehouse];
                updateDisplay();
            } catch (e) {
                alert("Ø®Ø·Ø£: " + e.message);
                els.startBtn.textContent = "ğŸš€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
                els.startBtn.disabled = false;
            }
        });

        function save() {
            localStorage.setItem('inv_' + currentWarehouse, JSON.stringify({ data: inventoryData, index: currentIndex }));
        }

        function updateDisplay() {
            if (!materials[currentIndex]) return;
            els.currentMaterial.textContent = materials[currentIndex];
            els.itemCounter.textContent = `${currentIndex + 1} / ${materials.length}`;
            
            document.getElementById('prev-btn').disabled = currentIndex === 0;
            document.getElementById('next-btn').disabled = currentIndex === materials.length - 1;

            const saved = inventoryData[currentIndex];
            els.statusDisplay.className = 'current-status-display';
            if (saved) {
                if (saved.status === 'available') {
                    els.statusDisplay.innerHTML = 'âœ… Ù…ØªÙˆÙØ±'; els.statusDisplay.classList.add('status-available-display');
                } else if (saved.status === 'shortage') {
                    els.statusDisplay.innerHTML = 'âš ï¸ Ø´Ø­ÙŠØ­'; els.statusDisplay.classList.add('status-shortage-display');
                } else {
                    els.statusDisplay.innerHTML = 'âŒ Ù…ÙÙ‚ÙˆØ¯'; els.statusDisplay.classList.add('status-missing-display');
                }
                if (saved.quantity !== null) els.statusDisplay.innerHTML += ` (${saved.quantity})`;
            } else {
                els.statusDisplay.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¬Ø±Ø¯';
                els.statusDisplay.classList.add('status-none-display');
            }
            
            els.qtySection.style.display = 'none';
            els.overlay.style.display = 'none';
            els.searchInput.value = '';
            els.suggestionsBox.style.display = 'none';
        }

        window.setStatus = function(status) {
            inventoryData[currentIndex] = { status, quantity: null };
            save();
            updateDisplay();
            setTimeout(() => {
                if (currentIndex < materials.length - 1) {
                    currentIndex++;
                    save();
                    updateDisplay();
                } else {
                    const fb = document.getElementById('finish-btn');
                    fb.style.backgroundColor = '#2980b9';
                    fb.style.transform = 'scale(1.1)';
                    setTimeout(() => { fb.style.transform = 'scale(1)'; }, 300);
                }
            }, 200);
        };

        document.getElementById('next-btn').onclick = () => { if(currentIndex < materials.length-1) { currentIndex++; save(); updateDisplay(); }};
        document.getElementById('prev-btn').onclick = () => { if(currentIndex > 0) { currentIndex--; save(); updateDisplay(); }};

        document.getElementById('quantity-btn').onclick = () => {
            els.qtySection.style.display = 'block';
            els.overlay.style.display = 'block';
            els.qtyInput.value = inventoryData[currentIndex]?.quantity || '';
            els.qtyInput.focus();
        };
        
        document.getElementById('quantity-submit').onclick = () => {
            let val = els.qtyInput.value.replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
            const qty = parseInt(val.replace(/\D/g, ''));
            if (isNaN(qty)) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù…');
            
            const status = qty === 0 ? 'missing' : (qty <= 5 ? 'shortage' : 'available');
            inventoryData[currentIndex] = { status, quantity: qty };
            save();
            updateDisplay();
            setTimeout(() => {
                if (currentIndex < materials.length - 1) {
                    currentIndex++;
                    save();
                    updateDisplay();
                }
            }, 200);
        };

        els.overlay.onclick = () => { els.qtySection.style.display='none'; els.overlay.style.display='none'; };

        els.searchInput.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            els.suggestionsBox.innerHTML = '';
            if(q.length < 2) { els.suggestionsBox.style.display = 'none'; return; }
            const matches = materials.map((m, i) => ({m, i})).filter(x => x.m.toLowerCase().includes(q)).slice(0,8);
            if(matches.length) {
                els.suggestionsBox.style.display = 'block';
                matches.forEach(h => {
                    const d = document.createElement('div');
                    d.className = `suggestion-item ${inventoryData[h.i] ? 'completed' : ''}`;
                    d.innerHTML = `<span>${h.m}</span> ${inventoryData[h.i] ? 'âœ…' : ''}`;
                    d.onclick = () => { currentIndex = h.i; updateDisplay(); };
                    els.suggestionsBox.appendChild(d);
                });
            } else els.suggestionsBox.style.display = 'none';
        });

        document.getElementById('finish-btn').onclick = () => {
            if (!confirm('Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ')) return;
            els.inputScreen.style.display = 'none';
            els.resultsScreen.style.display = 'block';
            renderReport();
        };

        function renderReport() {
            document.getElementById('report-wh-name').textContent = warehouseNames[currentWarehouse];
            document.getElementById('header-date').textContent = getFormattedDate();

            const cats = { available: [], shortage: [], missing: [] };
            materials.forEach((m, i) => {
                if (inventoryData[i]) cats[inventoryData[i].status].push({ name: m, qty: inventoryData[i].quantity });
            });

            document.getElementById('count-available').textContent = cats.available.length;
            document.getElementById('count-shortage').textContent = cats.shortage.length;
            document.getElementById('count-missing').textContent = cats.missing.length;

            const content = document.getElementById('report-content');
            content.innerHTML = '';

            const sections = [
                { id: 'available', title: 'âœ… Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªÙˆÙØ±Ø©', list: cats.available, color: '#27ae60' },
                { id: 'shortage', title: 'âš ï¸ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø´Ø­ÙŠØ­Ø©', list: cats.shortage, color: '#e67e22' },
                { id: 'missing', title: 'âŒ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©', list: cats.missing, color: '#c0392b' }
            ];

            sections.forEach(sec => {
                if (sec.list.length) {
                    let html = `<div class="section-block"><div class="section-header" style="background:${sec.color}">${sec.title}</div>
                    <table class="report-table"><thead><tr><th>Øª</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead><tbody>`;
                    sec.list.forEach((item, idx) => {
                        // Display Logic: Number OR Explicit Text
                        let displayVal = item.qty;
                        if (displayVal === null) {
                            if (sec.id === 'available') displayVal = 'Ù…ØªÙˆÙØ±';
                            else if (sec.id === 'shortage') displayVal = 'Ø´Ø­ÙŠØ­';
                            else if (sec.id === 'missing') displayVal = 'Ù…ÙÙ‚ÙˆØ¯';
                        }
                        
                        html += `<tr><td>${idx + 1}</td><td style="text-align:right">${item.name}</td><td>${displayVal}</td></tr>`;
                    });
                    html += `</tbody></table></div>`;
                    content.innerHTML += html;
                }
            });
        }

        document.getElementById('print-all-btn').onclick = () => {
            const t = document.title;
            document.title = getFileName(null);
            window.print();
            document.title = t;
        };

        document.getElementById('export-excel-btn').onclick = () => {
            const wb = XLSX.utils.book_new();
            const data = [['Øª', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø§Ù„Ø±ØµÙŠØ¯ / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª']];
            materials.forEach((m, i) => {
                if (inventoryData[i]) {
                    const s = inventoryData[i].status;
                    const sAr = s==='available'?'Ù…ØªÙˆÙØ±':(s==='shortage'?'Ø´Ø­ÙŠØ­':'Ù…ÙÙ‚ÙˆØ¯');
                    let val = inventoryData[i].quantity;
                    if(val === null) val = sAr; // Write text if no number
                    data.push([i+1, m, sAr, val]);
                }
            });
            const ws = XLSX.utils.aoa_to_sheet(data);
            ws['!cols'] = [{wch:5}, {wch:50}, {wch:15}, {wch:20}];
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, getFileName('xlsx'));
        };
    </script>
</body>
</html>
